# Flash日志BLE AT命令接口使用说明

## 概述

这是一个基于BLE（蓝牙低功耗）连接的Flash日志系统远程管理接口，通过AT命令方式提供日志的查询、管理和导出功能。适用于汽车电子等需要远程诊断的嵌入式系统。

## 系统特性

- **基于FTL的Flash日志系统**：支持3000条循环记录，自动垃圾回收
- **BLE无线连接**：通过蓝牙进行远程访问
- **AT命令接口**：标准化命令格式，易于集成
- **多种查询方式**：支持按时间、序列号、错误码查询
- **6字节错误码**：支持复杂的错误分类系统
- **数据完整性保护**：内置校验和机制

## BLE服务配置

### 服务参数
- **服务UUID**: `0x6E50`
- **RX特征值UUID**: `0x6E51` (接收AT命令)
- **TX特征值UUID**: `0x6E52` (发送响应)
- **最大MTU**: 247字节
- **缓冲区大小**: 512字节

### 连接流程
1. 扫描并连接到目标设备
2. 发现日志AT服务 (UUID: 0x6E50)
3. 启用TX特征值的通知功能
4. 通过RX特征值发送AT命令
5. 接收TX特征值的响应数据

## AT命令详解

### 命令格式
所有命令以 `AT+LOG` 开头，以 `\r` 结尾。

### 基础查询命令

#### 1. 帮助命令
```
AT+LOGHELP
```
**功能**: 显示所有支持的命令列表  
**响应**: 完整的命令帮助信息

#### 2. 系统状态查询
```
AT+LOGSTATUS
```
**功能**: 查询日志系统初始化状态  
**响应**: 系统状态和总条目数

#### 3. 统计信息
```
AT+LOGSTATS
```
**功能**: 获取详细的统计信息  
**响应包含**:
- 总条目数
- 已用/剩余空间
- 错误记录数量
- 写入周期数
- 最新/最旧记录时间戳

#### 4. 记录计数
```
AT+LOGCOUNT
```
**功能**: 快速获取当前日志条数  
**响应**: 纯数字，如 `1250`

### 日志读取命令

#### 5. 读取所有日志
```
AT+LOGREADALL
```
**功能**: 按时间顺序读取所有日志记录  
**适用场景**: 完整数据导出

#### 6. 读取最新记录
```
AT+LOGLATEST=<count>
```
**参数**: `count` - 要读取的记录数  
**示例**: `AT+LOGLATEST=10` (读取最新10条)  
**适用场景**: 快速查看最近发生的问题

#### 7. 按序列号范围读取
```
AT+LOGRANGE=<start_seq>,<end_seq>
```
**参数**: 
- `start_seq` - 起始序列号
- `end_seq` - 结束序列号

**示例**: `AT+LOGRANGE=100,200`  
**适用场景**: 查看特定时间段的记录

#### 8. 按时间范围读取
```
AT+LOGTIME=<start_time>,<end_time>
```
**参数**: 
- `start_time` - 起始时间戳
- `end_time` - 结束时间戳

**示例**: `AT+LOGTIME=1717830000,1717831000`  
**适用场景**: 分析特定时间窗口的事件

#### 9. 按错误码读取
```
AT+LOGERROR=<error_code_hex>,<match_bytes>
```
**参数**: 
- `error_code_hex` - 12字符十六进制错误码（6字节）
- `match_bytes` - 匹配字节数 (1-6)

**示例**: 
- `AT+LOGERROR=100200000001,2` (匹配前2字节)
- `AT+LOGERROR=100200000001,6` (完全匹配)

**适用场景**: 查找特定类型的错误

### 数据操作命令

#### 10. 插入日志记录（指定时间）
```
AT+LOGINSERT=<error_code_hex>,<year>,<month>,<day>,<hour>,<minute>,<second>
```
**参数**: 
- `error_code_hex` - 12字符十六进制错误码
- 时间参数 - 年月日时分秒

**示例**: `AT+LOGINSERT=100200000001,2025,6,17,14,30,15`  
**适用场景**: 手动记录特定时间的事件

#### 11. 插入日志记录（当前时间）
```
AT+LOGINSERTNOW=<error_code_hex>
```
**参数**: `error_code_hex` - 12字符十六进制错误码  
**示例**: `AT+LOGINSERTNOW=100200000001`  
**适用场景**: 快速记录当前事件

### 系统维护命令

#### 12. 完整性检查
```
AT+LOGCHECK
```
**功能**: 验证存储数据的完整性  
**适用场景**: 系统维护和故障诊断

#### 13. 清空所有日志
```
AT+LOGCLEAR
```
**功能**: 删除所有日志记录  
**⚠️ 警告**: 此操作不可恢复

## 响应格式

### 响应类型
- **成功响应**: `+LOGOK: <data>`
- **错误响应**: `+LOGERROR: <error_message>`
- **数据响应**: `+LOGDATA: <log_entry>`

### 日志条目格式
每条日志记录的格式为：
```
<total_count>,<current_index>,<timestamp>,<error_code_hex>,<checksum>
```

**字段说明**:
- `total_count` - 查询结果总数
- `current_index` - 当前条目索引
- `timestamp` - Unix时间戳（秒）
- `error_code_hex` - 12字符十六进制错误码
- `checksum` - 4字符十六进制校验和

**示例数据**:
```
+LOGDATA: 5,1,1717830615,100200000001,A5B3
+LOGDATA: 5,2,1717830620,200300000002,C7D1
+LOGDATA: 5,3,1717830625,300400000003,E9F2
```

## 错误码系统

### 错误码格式
- **长度**: 6字节 (12个十六进制字符)
- **格式**: `XXYYZZZZZZZZ`
  - `XX`: 主要错误类别
  - `YY`: 子类别
  - `ZZZZZZZZ`: 具体错误标识

### 常见错误类别示例
- `10xxxx`: 传感器错误
- `20xxxx`: 通信错误
- `30xxxx`: 电源错误
- `40xxxx`: 执行器错误

## 使用示例

### 完整的诊断流程

1. **连接设备并检查状态**
```
AT+LOGSTATUS
响应: +LOGOK: Flash log system: INITIALIZED
Total entries: 1250
```

2. **获取统计信息**
```
AT+LOGSTATS
响应: +LOGOK: Total entries: 1250
Used space: 30000 bytes
Free space: 42000 bytes
Error count: 45
Write cycles: 1250
Oldest time: 1717800000
Newest time: 1717830000
```

3. **查看最新错误**
```
AT+LOGLATEST=5
响应: +LOGOK: Reading latest 5 logs...
+LOGDATA: 5,1,1717830615,100200000001,A5B3
+LOGDATA: 5,2,1717830620,200300000002,C7D1
+LOGDATA: 5,3,1717830625,300400000003,E9F2
+LOGDATA: 5,4,1717830630,400500000004,1A2B
+LOGDATA: 5,5,1717830635,500600000005,3C4D
+LOGOK: Read complete, 5 entries
```

4. **查找特定错误类型**
```
AT+LOGERROR=100200000000,2
响应: +LOGOK: Reading error code 100200000000 (match 2 bytes)...
+LOGDATA: 3,1,1717830615,100200000001,A5B3
+LOGDATA: 3,2,1717830620,100200000002,C7D1
+LOGDATA: 3,3,1717830625,100200000003,E9F2
+LOGOK: Read complete, 3 entries
```

5. **记录测试事件**
```
AT+LOGINSERTNOW=FF0000000001
响应: +LOGOK: Log inserted with current time: [FF0000000001]
```

## 注意事项

### 性能考虑
- 单次读取大量数据时可能需要时间，建议分批处理
- BLE传输有MTU限制，大量数据会分包发送
- 频繁的Flash操作会影响系统性能

### 数据安全
- 清空操作不可恢复，使用前请确认
- 建议定期备份重要日志数据
- 注意BLE连接的安全性设置

### 兼容性
- 支持标准BLE 4.0及以上设备
- 兼容主流的BLE调试工具
- 可通过手机App或PC工具进行操作

## 故障排除

### 常见问题

1. **连接失败**
   - 检查设备是否在广播模式
   - 确认BLE服务已正确初始化
   - 验证UUID配置

2. **命令无响应**
   - 确认TX特征值通知已启用
   - 检查命令格式是否正确
   - 验证连接状态

3. **数据读取不完整**
   - 检查MTU设置
   - 确认缓冲区大小
   - 检查流控机制

4. **错误码解析问题**
   - 确认十六进制格式正确
   - 验证字节长度（必须12字符）
   - 检查大小写敏感性

通过这个接口，可以实现对嵌入式设备日志系统的完整远程管理，为故障诊断、系统维护和数据分析提供强大的支持。